<!doctype html>
<html lang="nl"><head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>10K Run Coach</title>
<style>
  :root { --bg:#0b0d10; --fg:#e7f0f7; --muted:#a8b3bd; --accent:#52d1ff; }
  html,body { margin:0; padding:0; background:var(--bg); color: var(--fg); font-family: -apple-system, BlinkMacSystemFont, system-ui, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; }
  .wrap { max-width: 820px; margin: 0 auto; padding: 20px 16px 80px; }
  h1 { font-size: 22px; margin: 0 0 12px; }
  p { line-height: 1.5; color: var(--muted); }
  select, button {
    width: 100%; box-sizing: border-box; margin: 8px 0 14px; padding: 12px;
    background: #12161a; color: var(--fg); border: 1px solid #1f2a33; border-radius: 10px;
    -webkit-appearance: none; appearance: none;
  }
  button.primary { background: var(--accent); color: #001018; border: none; font-weight: 700; }
  .row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
  .controls { position: sticky; bottom: 0; left: 0; right: 0; background: linear-gradient(180deg, rgba(11,13,16,0.0), rgba(11,13,16,0.85) 18%, rgba(11,13,16,1) 40%); padding: 12px 16px 20px; backdrop-filter: blur(6px); }
  .pill { display:inline-block; padding:6px 10px; border:1px solid #23313a; border-radius:999px; color:#bcd; font-size:12px; margin-right:6px; }
  .cue-list { margin-top: 8px; border: 1px solid #1f2a33; border-radius: 10px; overflow: hidden; }
  .cue { padding: 10px 12px; border-top: 1px solid #182028; display:flex; gap:12px; }
  .cue:first-child { border-top: none; }
  .t { color:#9bd; min-width:60px; }
  .txt { flex:1; color:#dbe6ef; word-break: break-word; }
  .warn { color:#ffd699; }
  footer { margin-top: 18px; color: var(--muted); font-size: 13px; }
  .debug { margin-top:8px; font-size:12px; color:#9ab; }
  .ver { margin-top:6px; font-size:12px; color:#788694; }
</style>
</head>
<body>
<div class="wrap">
  <h1>10K Run Coach – iPhone</h1>
  <p>Speelt gesproken aanwijzingen precies op tijd. <span class="warn">Tip:</span> je kunt je telefoon vergrendelen als de modus <b>MP3</b> is. In <b>TTS</b>-modus moet het scherm aan blijven.</p>
  <div class="ver">Build: v8 (TTS reset fix + stemkeuze blijvend)</div>

  <label for="session">Kies je sessie</label>
  <select id="session"></select>

  <div class="row">
    <div>
      <label for="voice">Stem (Nederlands)</label>
      <select id="voice"></select>
    </div>
    <div>
      <div class="pill" id="modePill" style="display:inline-block;margin-top:30px;">TTS</div>
    </div>
  </div>

  <div class="controls">
    <div class="row">
      <button class="primary" id="startBtn">▶︎ Start</button>
      <button id="stopBtn">■ Stop</button>
    </div>
    <div class="row">
      <button id="pauseBtn">⏸︎ Pauze</button>
      <button id="resumeBtn">⏵︎ Hervat</button>
    </div>
    <div>
      <span class="pill" id="status">Klaar</span>
      <span class="pill" id="elapsed">00:00</span>
    </div>
  </div>

  <div id="cueList" class="cue-list"></div>
  <div class="debug" id="debug">Status…</div>
  <footer>
    <p>Tip: voeg toe aan je beginscherm voor snel starten (Deel ▸ <i>Zet op beginscherm</i>).</p>
  </footer>
</div>

<!-- MP3-speler (onzichtbaar) -->
<audio id="mp3Player" preload="none" playsinline></audio>

<script>
/* ---------- Inhoud sessies ---------- */
const SESSIONS = /* ongewijzigd, ingekort voor leesbaarheid */ <?php /* bij jou staat hier de volledige SESSIONS array */ ?>;

/* ---------- Groepering per week/dag ---------- */
const SESSION_GROUPS = /* ongewijzigd */ <?php /* idem */ ?>;

/* ---------- UI refs ---------- */
const $ = sel => document.querySelector(sel);
const sessionSel = $("#session");
const voiceSel   = $("#voice");
const statusPill = $("#status");
const elapsedPill= $("#elapsed");
const cueList    = $("#cueList");
const startBtn   = $("#startBtn");
const stopBtn    = $("#stopBtn");
const pauseBtn   = $("#pauseBtn");
const resumeBtn  = $("#resumeBtn");
const debugEl    = $("#debug");
const modePill   = $("#modePill");
const mp3        = document.getElementById('mp3Player');

const MIN_START_DELAY_MS = 350;  // iets ruimer

let VOICES = [];
let NL_VOICES = [];
let timeouts = [];
let startEpoch = 0;
let pausedAt = 0;
let running = false;
let paused = false;
let currentSession = null;
let spokenCount = 0;

/* ====== AudioContext voor beeps (alleen TTS-modus) ====== */
let AC = null;
function getAC(){
  try { if (!AC) AC = new (window.AudioContext||window.webkitAudioContext)(); }
  catch(e){ AC = null; }
  return AC;
}
function beep(ms=80, freq=880){
  const ac = getAC();
  if (!ac) return;
  const o = ac.createOscillator();
  const g = ac.createGain();
  o.connect(g); g.connect(ac.destination);
  try { g.gain.setValueAtTime(0.0001, ac.currentTime); } catch(e){ g.gain.value = 0.0001; }
  try { g.gain.linearRampToValueAtTime(0.08, ac.currentTime + 0.01); } catch(e){}
  try { g.gain.exponentialRampToValueAtTime(0.0001, ac.currentTime + ms/1000); } catch(e){}
  o.frequency.value = freq;
  o.start(); o.stop(ac.currentTime + ms/1000 + 0.02);
}

/* ---------- Helpers ---------- */
function z2(n){ return (n<10?'0':'')+n; }
function fmt(ms){ const s = Math.max(0, Math.floor(ms/1000)); return z2(Math.floor(s/60))+':'+z2(s%60); }
function slugify(s){ return s.toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/^-+|-+$/g,'').slice(0,80); }
function mp3UrlFor(session){ return 'audio/' + slugify(session.title) + '.mp3'; }

/* ---------- Sessies UI ---------- */
function populateSessions() {
  sessionSel.innerHTML = "";
  const weekKeys = Object.keys(SESSION_GROUPS).map(k=>parseInt(k,10)).sort((a,b)=>a-b);
  if (!weekKeys.length) {
    const opt = document.createElement('option');
    opt.value = -1;
    opt.textContent = "⚠︎ Geen sessies gevonden";
    sessionSel.appendChild(opt);
    return;
  }
  weekKeys.forEach(week => {
    const og = document.createElement('optgroup');
    og.label = "Week " + week + " – trainingsdagen";
    (SESSION_GROUPS[week]||[]).forEach(row => {
      const opt = document.createElement('option');
      opt.value = row.idx;
      opt.textContent = SESSIONS[row.idx].title;
      og.appendChild(opt);
    });
    sessionSel.appendChild(og);
  });
}

function renderCues(sess) {
  cueList.innerHTML = "";
  if (!sess || !sess.cues) return;
  sess.cues.forEach(c => {
    const row = document.createElement('div');
    row.className = 'cue';
    const mm = z2(Math.floor(c.t/60));
    const ss = z2(c.t%60);
    row.innerHTML = `<div class="t">${mm}:${ss}</div><div class="txt">${c.text}</div>`;
    cueList.appendChild(row);
  });
}

/* ---------- Voices ---------- */
function loadVoices() {
  VOICES = speechSynthesis.getVoices() || [];
  NL_VOICES = VOICES.filter(v => (v.lang||'').toLowerCase().startsWith('nl'));
  const list = NL_VOICES.length ? NL_VOICES : VOICES;

  const savedName = localStorage.getItem('voiceName') || "";
  voiceSel.innerHTML = "";
  if (!list.length) {
    const opt = document.createElement('option');
    opt.value = "";
    opt.textContent = "⚠︎ Geen stemmen beschikbaar (tik op pagina en probeer Start)";
    voiceSel.appendChild(opt);
  } else {
    list.forEach((v) => {
      const opt = document.createElement('option');
      opt.value = v.name;
      opt.textContent = `${v.name} — ${v.lang}`;
      if (v.name === savedName) opt.selected = true;
      voiceSel.appendChild(opt);
    });
    // als savedName niet bestaat, kies NL of eerste
    if (!voiceSel.value && list.length) {
      const first = list[0];
      voiceSel.value = first.name;
      try { localStorage.setItem('voiceName', first.name); } catch(e){}
    }
  }
  updateDebug();
}
voiceSel.addEventListener('change', () => {
  try { localStorage.setItem('voiceName', voiceSel.value); } catch(e){}
});

function ensureVoicesLoaded(cb) {
  const v = speechSynthesis.getVoices();
  if (v && v.length) { loadVoices(); cb && cb(); return; }
  speechSynthesis.onvoiceschanged = () => { loadVoices(); cb && cb(); };
  setTimeout(() => { loadVoices(); cb && cb(); }, 1200);
}

function updateDebug() {
  const vc = (VOICES||[]).length;
  const nlc = (NL_VOICES||[]).length;
  const sc = (SESSIONS||[]).length;
  debugEl.textContent = `Sessies: ${sc} • Stemmen: ${vc} (NL: ${nlc})`;
}

/* ---------- Default sessie ---------- */
function pickDefaultSession(){
  try {
    const saved = localStorage.getItem('lastSessIdx');
    if (saved !== null && SESSIONS[+saved]) return +saved;
  } catch(e){}
  const nlDays = ['Zondag','Maandag','Dinsdag','Woensdag','Donderdag','Vrijdag','Zaterdag'];
  const today = nlDays[new Date().getDay()];
  const idx = SESSIONS.findIndex(s => s.title.includes(today));
  return idx >= 0 ? idx : 0;
}

/* ---------- MP3 of TTS kiezen ---------- */
let useMP3 = false;
async function pickAudioModeFor(sess){
  useMP3 = false;
  modePill.textContent = 'TTS';
  mp3.removeAttribute('src');
  if (!sess) return;

  const url = mp3UrlFor(sess);
  try {
    const res = await fetch(url, { method: 'HEAD', cache: 'no-store' });
    if (res.ok) {
      useMP3 = true;
      modePill.textContent = 'MP3';
      mp3.src = url;
      mp3.load();
    }
  } catch(e){}
}

/* ---------- iOS TTS reset hack ---------- */
function sleep(ms){ return new Promise(r => setTimeout(r, ms)); }

async function resetTTS() {
  try { speechSynthesis.cancel(); } catch(e){}
  await sleep(140);
  try {
    // ultrakorte, bijna stille utterance om engine te “ontwaken”
    const blank = new SpeechSynthesisUtterance(' ');
    blank.rate = 1.0; blank.pitch = 1.0; blank.volume = 0.01; // niet 0 op iOS
    const voices = speechSynthesis.getVoices() || [];
    const selName = voiceSel && voiceSel.value;
    const pick = voices.find(v => v.name === selName)
              || voices.find(v => (v.lang||'').toLowerCase().startsWith('nl'))
              || voices[0];
    if (pick) { blank.voice = pick; blank.lang = pick.lang || 'nl-NL'; } else { blank.lang = 'nl-NL'; }
    const done = new Promise(res => { blank.onend = blank.onerror = () => res(); });
    speechSynthesis.speak(blank);
    await Promise.race([done, sleep(180)]);
    speechSynthesis.cancel();
  } catch(e){}
  await sleep(120);
}

/* ---------- Init ---------- */
function init() {
  populateSessions();
  const defIdx = pickDefaultSession();
  sessionSel.value = String(defIdx);
  currentSession = SESSIONS[defIdx];
  renderCues(currentSession);
  pickAudioModeFor(currentSession).then(()=>{});
  ensureVoicesLoaded();
  updateDebug();
}

sessionSel.addEventListener('change', async () => {
  const idx = parseInt(sessionSel.value, 10);
  currentSession = Number.isInteger(idx) && idx >= 0 ? SESSIONS[idx] : null;
  renderCues(currentSession);
  stopAll();
  await pickAudioModeFor(currentSession);
  try { localStorage.setItem('lastSessIdx', String(idx)); } catch(e){}
});

function setStatus(txt){ statusPill.textContent = txt; }

/* ---------- TTS speak & schedule ---------- */
function speak(text) {
  const voices = speechSynthesis.getVoices() || [];
  const selName = voiceSel && voiceSel.value;
  const pick = voices.find(v => v.name === selName)
           || voices.find(v => (v.lang||'').toLowerCase().startsWith('nl'))
           || voices[0];

  const u = new SpeechSynthesisUtterance(text);
  if (pick) { u.voice = pick; u.lang = pick.lang || 'nl-NL'; } else { u.lang = 'nl-NL'; }
  u.rate = 1.0; u.pitch = 1.0; u.volume = 1.0;

  speechSynthesis.speak(u);
}

function clearTimeouts() {
  timeouts.forEach(id => clearTimeout(id));
  timeouts = [];
}

let ticker = null;
function startTicker() {
  if (ticker) clearInterval(ticker);
  ticker = setInterval(() => {
    if (!running) return;
    const now = paused ? pausedAt : Date.now();
    elapsedPill.textContent = fmt(now - startEpoch);
  }, 250);
}

function schedule(sess, offsetMs = 0) {
  clearTimeouts();
  if (!sess || !sess.cues || !sess.cues.length) return;

  const base = Date.now() + MIN_START_DELAY_MS - offsetMs;
  startEpoch = base;

  sess.cues.forEach((c, idx) => {
    const at = base + c.t * 1000;
    const delay = Math.max(0, at - Date.now());

    const pre = Math.max(0, delay - 1000);
    const preId = setTimeout(() => { if (running && !useMP3) beep(); }, pre);
    timeouts.push(preId);

    const id = setTimeout(() => {
      if (!running || useMP3) return;
      speak(c.text);
      spokenCount = idx + 1;
    }, delay);
    timeouts.push(id);
  });

  startTicker();
}

/* ---------- Start/Stop/Pauze/Hervat ---------- */
function stopAll() {
  running = false;
  paused = false;
  clearTimeouts();
  if (useMP3) {
    try { mp3.pause(); mp3.currentTime = 0; } catch(e){}
  } else {
    try { speechSynthesis.cancel(); } catch(e){}
  }
  setStatus('Klaar');
  elapsedPill.textContent = '00:00';
  spokenCount = 0;
}

startBtn.addEventListener('click', async () => {
  if (!currentSession) return;
  stopAll();
  running = true;
  paused = false;
  setStatus('Bezig');

  if (useMP3) {
    try { mp3.currentTime = 0; } catch(e){}
    startEpoch = Date.now();
    startTicker();
    const p = mp3.play();
    if (p && p.catch) p.catch(()=>{});
  } else {
    try {
      AC = getAC();
      const o = AC.createOscillator();
      const g = AC.createGain();
      o.connect(g); g.connect(AC.destination);
      g.gain.value = 0.0001; o.start(); o.stop(AC.currentTime + 0.05);
    } catch(e){}

    await resetTTS();                        // <<< iOS fix
    ensureVoicesLoaded(() => schedule(currentSession, 0));
  }
});

stopBtn.addEventListener('click', stopAll);

pauseBtn.addEventListener('click', () => {
  if (!running || paused) return;
  paused = true;
  if (useMP3) {
    try { mp3.pause(); } catch(e){}
    pausedAt = Date.now();
  } else {
    clearTimeouts();
    try { speechSynthesis.cancel(); } catch(e){}
    pausedAt = Date.now();
  }
  setStatus('Gepauzeerd');
});

resumeBtn.addEventListener('click', async () => {
  if (!running || !paused) return;
  paused = false;
  setStatus('Bezig');

  if (useMP3) {
    const p = mp3.play();
    if (p && p.catch) p.catch(()=>{});
  } else {
    const elapsed = pausedAt - startEpoch;
    const remain = { title: currentSession.title, cues: currentSession.cues.filter(c => c.t * 1000 >= elapsed) };
    await resetTTS();                        // <<< iOS fix bij hervatten
    schedule(remain, elapsed);
  }
});

/* ---------- MP3 events ---------- */
mp3.addEventListener('ended', () => {
  running = false; paused = false; setStatus('Klaar');
});

/* ---------- Boot ---------- */
document.addEventListener('DOMContentLoaded', init);
document.addEventListener('touchstart', () => ensureVoicesLoaded(), {once:true});
document.addEventListener('click', () => ensureVoicesLoaded(), {once:true});
</script>
</body></html>
