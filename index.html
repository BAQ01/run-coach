<!doctype html>
<html lang="nl"><head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>10K Run Coach</title>
<style>
  :root { --bg:#0b0d10; --fg:#e7f0f7; --muted:#a8b3bd; --accent:#52d1ff; }
  html,body { margin:0; padding:0; background:var(--bg); color: var(--fg); font-family: -apple-system, BlinkMacSystemFont, system-ui, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; }
  .wrap { max-width: 820px; margin: 0 auto; padding: 20px 16px 80px; }
  h1 { font-size: 22px; margin: 0 0 12px; }
  p { line-height: 1.5; color: var(--muted); }
  select, button, input[type=range] {
    width: 100%; box-sizing: border-box; margin: 8px 0 14px; padding: 12px;
    background: #12161a; color: var(--fg); border: 1px solid #1f2a33; border-radius: 10px;
    -webkit-appearance: none; appearance: none;
  }
  button.primary { background: var(--accent); color: #001018; border: none; font-weight: 700; }
  .row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
  .controls { position: sticky; bottom: 0; left: 0; right: 0; background: linear-gradient(180deg, rgba(11,13,16,0.0), rgba(11,13,16,0.85) 18%, rgba(11,13,16,1) 40%); padding: 12px 16px 20px; backdrop-filter: blur(6px); }
  .pill { display:inline-block; padding:6px 10px; border:1px solid #23313a; border-radius:999px; color:#bcd; font-size:12px; margin-right:6px; }
  .cue-list { margin-top: 8px; border: 1px solid #1f2a33; border-radius: 10px; overflow: hidden; }
  .cue { padding: 10px 12px; border-top: 1px solid #182028; display:flex; gap:12px; }
  .cue:first-child { border-top: none; }
  .t { color:#9bd; min-width:60px; }
  .txt { flex:1; color:#dbe6ef; word-break: break-word; }
  .warn { color:#ffd699; }
  footer { margin-top: 18px; color: var(--muted); font-size: 13px; }
  .debug { margin-top:8px; font-size:12px; color:#9ab; }
  .ver { margin-top:6px; font-size:12px; color:#788694; }
</style>
</head>
<body>
<div class="wrap">
  <h1>10K Run Coach – iPhone</h1>
  <p>Speelt gesproken aanwijzingen precies op tijd. <span class="warn">Tip:</span> zet <b>Niet storen</b> aan en houd het scherm actief tijdens je run.</p>
  <div class="ver">Build: v6 (GitHub Pages + geheugen + pre-beep)</div>
  <label for="session">Kies je sessie</label>
  <select id="session"></select>
  <div class="row">
    <div>
      <label for="voice">Stem (Nederlands)</label>
      <select id="voice"></select>
    </div>
    <div>
      <label for="rate">Spreeksnelheid: <span id="rateVal">1.0×</span></label>
      <input type="range" id="rate" min="0.7" max="1.3" step="0.05" value="1.0">
    </div>
  </div>
  <div class="controls">
    <div class="row">
      <button class="primary" id="startBtn">▶︎ Start</button>
      <button id="stopBtn">■ Stop</button>
    </div>
    <div class="row">
      <button id="pauseBtn">⏸︎ Pauze</button>
      <button id="resumeBtn">⏵︎ Hervat</button>
    </div>
    <div>
      <span class="pill" id="status">Klaar</span>
      <span class="pill" id="elapsed">00:00</span>
    </div>
  </div>
  <div id="cueList" class="cue-list"></div>
  <div class="debug" id="debug">Status…</div>
  <footer>
    <p>Tip: voeg toe aan je beginscherm voor snel starten (Deel ▸ <i>Zet op beginscherm</i>).</p>
  </footer>
</div>
<script>
/* ---------- Inhoud sessies (VOLLEDIG) ---------- */
const SESSIONS = [
  {"title":"Week 1 - Maandag: Rustig + Versnellingen (±30 min)","cues":[
    {"t":0,"text":"Start! 5 min vlot wandelen en rustig losdribbelen. Schouders laag, adem diep."},
    {"t":180,"text":"Nog 2 min rustig opwarmen."},
    {"t":270,"text":"Nog 30 seconden, klaar voor rustig hardlopen."},
    {"t":300,"text":"Klaar met opwarmen."},
    {"t":300,"text":"Nu 16 min rustig hardlopen op praattempo."},
    {"t":780,"text":"Halverwege dit rustige blok. Houd je pas kort en licht."},
    {"t":1260,"text":"Rustig blok klaar."},
    {"t":1260,"text":"Versnelling 1/4: 15 seconden iets sneller, ontspannen armen."},
    {"t":1275,"text":"Terug naar 45 seconden rustig joggen of wandelen."},
    {"t":1320,"text":"Versnelling 2/4: 15 seconden iets sneller, ontspannen armen."},
    {"t":1335,"text":"Terug naar 45 seconden rustig joggen of wandelen."},
    {"t":1380,"text":"Versnelling 3/4: 15 seconden iets sneller, ontspannen armen."},
    {"t":1395,"text":"Terug naar 45 seconden rustig joggen of wandelen."},
    {"t":1440,"text":"Versnelling 4/4: 15 seconden iets sneller, ontspannen armen."},
    {"t":1455,"text":"Terug naar 45 seconden rustig joggen of wandelen."},
    {"t":1500,"text":"Uitlopen: 5 min rustig wandelen. Schud benen los."},
    {"t":1770,"text":"Nog 30 seconden, goed gedaan!"},
    {"t":1800,"text":"Einde sessie. Drink wat water."}
  ]},
  {"title":"Week 1 - Woensdag: 6×2 min sneller / 2 min rustig (±39 min)","cues":[
    {"t":0,"text":"Start warming-up: 10 min makkelijk. Adem rustig, beweeg ontspannen."},
    {"t":480,"text":"Nog 2 min warming-up."},
    {"t":570,"text":"Nog 30 seconden, maak je klaar voor het eerste interval."},
    {"t":600,"text":"Warming-up klaar."},
    {"t":600,"text":"Interval 1/6: 2 min sneller tempo. Je kunt nog losse woorden zeggen."},
    {"t":720,"text":"Herstel: 2 min heel rustig joggen of wandelen."},
    {"t":840,"text":"Interval 2/6: 2 min sneller tempo. Je kunt nog losse woorden zeggen."},
    {"t":960,"text":"Herstel: 2 min heel rustig joggen of wandelen."},
    {"t":1080,"text":"Interval 3/6: 2 min sneller tempo. Je kunt nog losse woorden zeggen."},
    {"t":1200,"text":"Herstel: 2 min heel rustig joggen of wandelen."},
    {"t":1320,"text":"Interval 4/6: 2 min sneller tempo. Je kunt nog losse woorden zeggen."},
    {"t":1440,"text":"Herstel: 2 min heel rustig joggen of wandelen."},
    {"t":1560,"text":"Interval 5/6: 2 min sneller tempo. Je kunt nog losse woorden zeggen."},
    {"t":1680,"text":"Herstel: 2 min heel rustig joggen of wandelen."},
    {"t":1800,"text":"Interval 6/6: 2 min sneller tempo. Je kunt nog losse woorden zeggen."},
    {"t":1920,"text":"Herstel: 2 min heel rustig joggen of wandelen."},
    {"t":2040,"text":"Uitlopen: 5 min rustig. Diepe ademhaling, schouders los."},
    {"t":2340,"text":"Einde sessie. Top gedaan."}
  ]},
  {"title":"Week 1 - Vrijdag: Tempoblok 20 min (±35 min)","cues":[
    {"t":0,"text":"Start: 10 min rustig inlopen. Praattempo, ontspannen armen."},
    {"t":480,"text":"Nog 2 min rustig. Zo ga je naar iets sneller tempo."},
    {"t":570,"text":"Nog 30 sec. Klaar voor tempo."},
    {"t":600,"text":"Inlopen klaar."},
    {"t":600,"text":"Tempo-blok: 20 min stevig maar gecontroleerd tempo. Korte zinnen kunnen praten."},
    {"t":1200,"text":"Halverwege. Houd cadans ritmisch en borst omhoog."},
    {"t":1800,"text":"Tempo-blok klaar."},
    {"t":1800,"text":"Uitlopen: 5 min rustig. Laat je adem zakken."},
    {"t":2100,"text":"Einde sessie. Goed werk!"}
  ]},
  {"title":"Week 1 - Zondag: Lange rustige duurloop (±50 min)","cues":[
    {"t":0,"text":"Start: 5 min rustig opwarmen. Vandaag is het lang en rustig."},
    {"t":300,"text":"Opwarming afgerond."},
    {"t":300,"text":"Nu 40 min op praattempo. Begin ontspannen."},
    {"t":600,"text":"5 minuten bezig. Check houding: rechtop, schouders laag."},
    {"t":900,"text":"10 minuten bezig. Check houding: rechtop, schouders laag."},
    {"t":1200,"text":"15 minuten bezig. Check houding: rechtop, schouders laag."},
    {"t":1500,"text":"20 minuten bezig. Check houding: rechtop, schouders laag."},
    {"t":1800,"text":"25 minuten bezig. Check houding: rechtop, schouders laag."},
    {"t":2100,"text":"30 minuten bezig. Check houding: rechtop, schouders laag."},
    {"t":2400,"text":"35 minuten bezig. Check houding: rechtop, schouders laag."},
    {"t":2700,"text":"Uitlopen: 5 min rustig wandelen."},
    {"t":3000,"text":"Einde sessie. Drink wat en rek rustig uit."}
  ]},
  {"title":"Week 2 - Maandag: Rustig + 6 versnellingen (±36 min)","cues":[
    {"t":0,"text":"Start: 5 min rustig opwarmen."},
    {"t":300,"text":"Opwarming klaar."},
    {"t":300,"text":"Nu 20 min rustig hardlopen op praattempo."},
    {"t":900,"text":"Halverwege. Ontspan handen en kaken."},
    {"t":1500,"text":"Rustig blok klaar."},
    {"t":1500,"text":"Versnelling 1/6: 15 seconden iets sneller."},
    {"t":1515,"text":"Herstel: 45 seconden rustig joggen of wandelen."},
    {"t":1560,"text":"Versnelling 2/6: 15 seconden iets sneller."},
    {"t":1575,"text":"Herstel: 45 seconden rustig joggen of wandelen."},
    {"t":1620,"text":"Versnelling 3/6: 15 seconden iets sneller."},
    {"t":1635,"text":"Herstel: 45 seconden rustig joggen of wandelen."},
    {"t":1680,"text":"Versnelling 4/6: 15 seconden iets sneller."},
    {"t":1695,"text":"Herstel: 45 seconden rustig joggen of wandelen."},
    {"t":1740,"text":"Versnelling 5/6: 15 seconden iets sneller."},
    {"t":1755,"text":"Herstel: 45 seconden rustig joggen of wandelen."},
    {"t":1800,"text":"Versnelling 6/6: 15 seconden iets sneller."},
    {"t":1815,"text":"Herstel: 45 seconden rustig joggen of wandelen."},
    {"t":1860,"text":"Uitlopen 5 min rustig."},
    {"t":2160,"text":"Einde sessie. Goed bezig!"}
  ]},
  {"title":"Week 2 - Dinsdag: 5×3 min sneller / 2 min rustig (±40 min)","cues":[
    {"t":0,"text":"Warming-up: 10 min rustig. Bereid je voor op 5 blokken."},
    {"t":600,"text":"Warming-up klaar."},
    {"t":600,"text":"Blok 1/5: 3 min sneller, ritmisch ademhalen."},
    {"t":780,"text":"Herstel: 2 min heel rustig."},
    {"t":900,"text":"Blok 2/5: 3 min sneller, ritmisch ademhalen."},
    {"t":1080,"text":"Herstel: 2 min heel rustig."},
    {"t":1200,"text":"Blok 3/5: 3 min sneller, ritmisch ademhalen."},
    {"t":1380,"text":"Herstel: 2 min heel rustig."},
    {"t":1500,"text":"Blok 4/5: 3 min sneller, ritmisch ademhalen."},
    {"t":1680,"text":"Herstel: 2 min heel rustig."},
    {"t":1800,"text":"Blok 5/5: 3 min sneller, ritmisch ademhalen."},
    {"t":1980,"text":"Herstel: 2 min heel rustig."},
    {"t":2100,"text":"Uitlopen: 5 min rustig. Adem zakt."},
    {"t":2400,"text":"Einde sessie. Sterk gedaan."}
  ]},
  {"title":"Week 2 - Donderdag: Progressie-run (±45 min)","cues":[
    {"t":0,"text":"Start: 20 min rustig op praattempo. Voel je soepel ritme."},
    {"t":600,"text":"Halverwege van het rustige deel."},
    {"t":1200,"text":"Klaar met rustige aanloop."},
    {"t":1200,"text":"Nu 15 min iets sneller (tempo). Houd het gecontroleerd."},
    {"t":1680,"text":"Nog 7 min in dit tempo. Blijf ontspannen."},
    {"t":2100,"text":"Tempo-deel klaar."},
    {"t":2100,"text":"Afsluiten met 10 min heel rustig."},
    {"t":2700,"text":"Einde sessie. Netjes!"}
  ]},
  {"title":"Week 2 - Vrijdag (optioneel): Herstelrun (±25 min)","cues":[
    {"t":0,"text":"Optioneel: 5 min rustig opwarmen."},
    {"t":300,"text":"Opwarming klaar."},
    {"t":300,"text":"15 min loslopen op heel rustig tempo. Focus op soepele pas."},
    {"t":780,"text":"Halverwege. Blijf het makkelijk houden."},
    {"t":1200,"text":"Losloop klaar."},
    {"t":1200,"text":"Uitlopen: 5 min wandelen."},
    {"t":1500,"text":"Einde optionele sessie."}
  ]},
  {"title":"Week 2 - Zondag: Lange rustige duurloop (±70 min)","cues":[
    {"t":0,"text":"Start: 5 min rustig opwarmen. Vandaag iets langer."},
    {"t":300,"text":"Opwarming klaar."},
    {"t":300,"text":"Nu 60 min op praattempo. Blijf economisch lopen."},
    {"t":900,"text":"10 minuten bezig. Check je houding en ontspanning."},
    {"t":1500,"text":"20 minuten bezig. Check je houding en ontspanning."},
    {"t":2100,"text":"30 minuten bezig. Check je houding en ontspanning."},
    {"t":2700,"text":"40 minuten bezig. Check je houding en ontspanning."},
    {"t":3300,"text":"50 minuten bezig. Check je houding en ontspanning."},
    {"t":3900,"text":"Uitlopen: 5 min rustig wandelen."},
    {"t":4200,"text":"Einde sessie. Vul je vocht aan en eet iets kleins."}
  ]},
  {"title":"Week 3 - Maandag: Rustig + looptechniek (±30 min)","cues":[
    {"t":0,"text":"Start: 5 min rustig opwarmen."},
    {"t":300,"text":"Opwarming klaar."},
    {"t":300,"text":"20 min rustig hardlopen. Let op lichte, snelle pas."},
    {"t":900,"text":"Halverwege. Houd je romp stabiel en kijk vooruit."},
    {"t":1500,"text":"Rustig gedeelte klaar."},
    {"t":1500,"text":"Techniek ronde 1: Hoge knieën 20 sec."},
    {"t":1520,"text":"Techniek ronde 1: Rust 20 sec."},
    {"t":1540,"text":"Techniek ronde 1: Hak-billen 20 sec."},
    {"t":1560,"text":"Techniek ronde 1: Rust 20 sec."},
    {"t":1580,"text":"Techniek ronde 1: Skips (huppels) 20 sec."},
    {"t":1600,"text":"Techniek ronde 1: Rust 60 sec."},
    {"t":1660,"text":"Techniek ronde 2: Hoge knieën 20 sec."},
    {"t":1680,"text":"Techniek ronde 2: Rust 20 sec."},
    {"t":1700,"text":"Techniek ronde 2: Hak-billen 20 sec."},
    {"t":1720,"text":"Techniek ronde 2: Rust 20 sec."},
    {"t":1740,"text":"Techniek ronde 2: Skips (huppels) 20 sec."},
    {"t":1760,"text":"Techniek ronde 2: Rust 60 sec."},
    {"t":1820,"text":"Uitlopen: 5 min rustig wandelen en losdribbelen."},
    {"t":2120,"text":"Einde sessie. Lekker soepel!"}
  ]},
  {"title":"Week 3 - Dinsdag: 5×4 min sneller / 2 min rustig (±45 min)","cues":[
    {"t":0,"text":"Warming-up: 10 min rustig. Bereid je voor op 5×4 min."},
    {"t":600,"text":"Warming-up klaar."},
    {"t":600,"text":"Interval 1/5: 4 min sneller. Focus op ritme en houding."},
    {"t":840,"text":"Herstel: 2 min heel rustig."},
    {"t":960,"text":"Interval 2/5: 4 min sneller. Focus op ritme en houding."},
    {"t":1200,"text":"Herstel: 2 min heel rustig."},
    {"t":1320,"text":"Interval 3/5: 4 min sneller. Focus op ritme en houding."},
    {"t":1560,"text":"Herstel: 2 min heel rustig."},
    {"t":1680,"text":"Interval 4/5: 4 min sneller. Focus op ritme en houding."},
    {"t":1920,"text":"Herstel: 2 min heel rustig."},
    {"t":2040,"text":"Interval 5/5: 4 min sneller. Focus op ritme en houding."},
    {"t":2280,"text":"Herstel: 2 min heel rustig."},
    {"t":2400,"text":"Uitlopen: 5 min rustig."},
    {"t":2700,"text":"Einde sessie. Sterk werk."}
  ]},
  {"title":"Week 3 - Donderdag: Losloop met korte versnellingen (±25 min)","cues":[
    {"t":0,"text":"Start: 5 min rustig opwarmen."},
    {"t":300,"text":"Opwarming klaar."},
    {"t":300,"text":"Nu 15 min héél rustig. We voegen 4 korte versnellingen toe."},
    {"t":480,"text":"Versnelling: 10 sec iets sneller, daarna terug naar rustig."},
    {"t":660,"text":"Versnelling: 10 sec iets sneller, daarna terug naar rustig."},
    {"t":840,"text":"Versnelling: 10 sec iets sneller, daarna terug naar rustig."},
    {"t":1020,"text":"Versnelling: 10 sec iets sneller, daarna terug naar rustig."},
    {"t":1200,"text":"Uitlopen: 5 min rustig wandelen."},
    {"t":1500,"text":"Einde sessie. Fris blijven, morgen rust."}
  ]},
  {"title":"Week 3 - Zondag: 10 km gids (60 min)","cues":[
    {"t":0,"text":"Start 10 km gids (60 min). Begin conservatief. Adem ritmisch."},
    {"t":300,"text":"5 min onderweg. Blijf ontspannen, praattempo-plus."},
    {"t":600,"text":"10 min onderweg. Blijf ontspannen, praattempo-plus."},
    {"t":900,"text":"Nu stabiel tempo. Stel je voor dat je kilometers 4 tot 7 loopt."},
    {"t":1200,"text":"20 min onderweg. Houd ritme, blijf economisch."},
    {"t":1500,"text":"25 min onderweg. Houd ritme, blijf economisch."},
    {"t":1800,"text":"30 min onderweg. Houd ritme, blijf economisch."},
    {"t":2100,"text":"35 min onderweg. Houd ritme, blijf economisch."},
    {"t":2400,"text":"40 min onderweg. Houd ritme, blijf economisch."},
    {"t":2700,"text":"Laatste 15 min: als je je goed voelt, iets versnellen. Houd vorm!"},
    {"t":3000,"text":"Nog 10 min tot finish van deze audio. Blijf duwen, focus."},
    {"t":3300,"text":"Nog 5 min tot finish van deze audio. Blijf duwen, focus."},
    {"t":3540,"text":"Nog 1 minuut. Rechte rug, snelle lichte pas."},
    {"t":3600,"text":"Audio klaar. Als je 10 km hebt gehaald: gefeliciteerd! Anders: rustig doorlopen tot je horloge 10 km zegt."}
  ]},
  {"title":"Week 3 - Zondag: 10 km gids (75 min)","cues":[
    {"t":0,"text":"Start 10 km gids (75 min). Begin conservatief. Adem ritmisch."},
    {"t":300,"text":"5 min onderweg. Blijf ontspannen, praattempo-plus."},
    {"t":600,"text":"10 min onderweg. Blijf ontspannen, praattempo-plus."},
    {"t":900,"text":"Nu stabiel tempo. Stel je voor dat je kilometers 4 tot 7 loopt."},
    {"t":1200,"text":"20 min onderweg. Houd ritme, blijf economisch."},
    {"t":1500,"text":"25 min onderweg. Houd ritme, blijf economisch."},
    {"t":1800,"text":"30 min onderweg. Houd ritme, blijf economisch."},
    {"t":2100,"text":"35 min onderweg. Houd ritme, blijf economisch."},
    {"t":2400,"text":"40 min onderweg. Houd ritme, blijf economisch."},
    {"t":2700,"text":"45 min onderweg. Houd ritme, blijf economisch."},
    {"t":3000,"text":"50 min onderweg. Houd ritme, blijf economisch."},
    {"t":3300,"text":"55 min onderweg. Houd ritme, blijf economisch."},
    {"t":3600,"text":"Laatste 15 min: als je je goed voelt, iets versnellen. Houd vorm!"},
    {"t":3900,"text":"Nog 10 min tot finish van deze audio. Blijf duwen, focus."},
    {"t":4200,"text":"Nog 5 min tot finish van deze audio. Blijf duwen, focus."},
    {"t":4440,"text":"Nog 1 minuut. Rechte rug, snelle lichte pas."},
    {"t":4500,"text":"Audio klaar. Als je 10 km hebt gehaald: gefeliciteerd! Anders: rustig doorlopen tot je horloge 10 km zegt."}
  ]}
];

/* ---------- Groepering per week/dag ---------- */
const SESSION_GROUPS = {
  "1":[
    {"idx":0,"title":"Week 1 - Maandag: Rustig + Versnellingen (±30 min)","day_order":1},
    {"idx":1,"title":"Week 1 - Woensdag: 6×2 min sneller / 2 min rustig (±39 min)","day_order":3},
    {"idx":2,"title":"Week 1 - Vrijdag: Tempoblok 20 min (±35 min)","day_order":5},
    {"idx":3,"title":"Week 1 - Zondag: Lange rustige duurloop (±50 min)","day_order":7}
  ],
  "2":[
    {"idx":4,"title":"Week 2 - Maandag: Rustig + 6 versnellingen (±36 min)","day_order":1},
    {"idx":5,"title":"Week 2 - Dinsdag: 5×3 min sneller / 2 min rustig (±40 min)","day_order":2},
    {"idx":6,"title":"Week 2 - Donderdag: Progressie-run (±45 min)","day_order":4},
    {"idx":7,"title":"Week 2 - Vrijdag (optioneel): Herstelrun (±25 min)","day_order":5},
    {"idx":8,"title":"Week 2 - Zondag: Lange rustige duurloop (±70 min)","day_order":7}
  ],
  "3":[
    {"idx":9,"title":"Week 3 - Maandag: Rustig + looptechniek (±30 min)","day_order":1},
    {"idx":10,"title":"Week 3 - Dinsdag: 5×4 min sneller / 2 min rustig (±45 min)","day_order":2},
    {"idx":11,"title":"Week 3 - Donderdag: Losloop met korte versnellingen (±25 min)","day_order":4},
    {"idx":12,"title":"Week 3 - Zondag: 10 km gids (60 min)","day_order":7},
    {"idx":13,"title":"Week 3 - Zondag: 10 km gids (75 min)","day_order":7}
  ]
};

/* ---------- UI refs ---------- */
const $ = sel => document.querySelector(sel);
const sessionSel = $("#session");
const voiceSel = $("#voice");
const rateSl = $("#rate");
const rateVal = $("#rateVal");
const statusPill = $("#status");
const elapsedPill = $("#elapsed");
const cueList = $("#cueList");
const startBtn = $("#startBtn");
const stopBtn = $("#stopBtn");
const pauseBtn = $("#pauseBtn");
const resumeBtn = $("#resumeBtn");
const debugEl = $("#debug");

let VOICES = [];
let NL_VOICES = [];
let timeouts = [];
let startEpoch = 0;
let pausedAt = 0;
let running = false;
let paused = false;
let currentSession = null;
let spokenCount = 0;

/* ====== Gedeelde AudioContext + beep ====== */
let AC = null;
function getAC(){
  try { if (!AC) AC = new (window.AudioContext||window.webkitAudioContext)(); }
  catch(e){ AC = null; }
  return AC;
}
function beep(ms=80, freq=880){
  const ac = getAC();
  if (!ac) return;
  const o = ac.createOscillator();
  const g = ac.createGain();
  o.connect(g); g.connect(ac.destination);
  try { g.gain.setValueAtTime(0.0001, ac.currentTime); } catch(e){ g.gain.value = 0.0001; }
  try { g.gain.linearRampToValueAtTime(0.08, ac.currentTime + 0.01); } catch(e){}
  try { g.gain.exponentialRampToValueAtTime(0.0001, ac.currentTime + ms/1000); } catch(e){}
  o.frequency.value = freq;
  o.start();
  o.stop(ac.currentTime + ms/1000 + 0.02);
}

/* ---------- Helpers ---------- */
function z2(n) { return (n<10?'0':'')+n; }
function fmt(ms) {
  const s = Math.max(0, Math.floor(ms/1000));
  return z2(Math.floor(s/60))+':'+z2(s%60);
}

function populateSessions() {
  sessionSel.innerHTML = "";
  const weekKeys = Object.keys(SESSION_GROUPS).map(k=>parseInt(k,10)).sort((a,b)=>a-b);
  if (!weekKeys.length) {
    const opt = document.createElement('option');
    opt.value = -1;
    opt.textContent = "⚠︎ Geen sessies gevonden";
    sessionSel.appendChild(opt);
    return;
  }
  weekKeys.forEach(week => {
    const og = document.createElement('optgroup');
    og.label = "Week " + week + " – trainingsdagen";
    (SESSION_GROUPS[week]||[]).forEach(row => {
      if (SESSIONS[row.idx]) {
        const opt = document.createElement('option');
        opt.value = row.idx;
        opt.textContent = SESSIONS[row.idx].title;
        og.appendChild(opt);
      }
    });
    sessionSel.appendChild(og);
  });
}

function renderCues(sess) {
  cueList.innerHTML = "";
  if (!sess || !sess.cues) return;
  sess.cues.forEach(c => {
    const row = document.createElement('div');
    row.className = 'cue';
    const mm = z2(Math.floor(c.t/60));
    const ss = z2(c.t%60);
    row.innerHTML = `<div class="t">${mm}:${ss}</div><div class="txt">${c.text}</div>`;
    cueList.appendChild(row);
  });
}

function loadVoices() {
  VOICES = speechSynthesis.getVoices() || [];
  NL_VOICES = VOICES.filter(v => (v.lang||'').toLowerCase().startsWith('nl'));
  voiceSel.innerHTML = "";
  const list = NL_VOICES.length ? NL_VOICES : VOICES;
  if (!list.length) {
    const opt = document.createElement('option');
    opt.value = "";
    opt.textContent = "⚠︎ Geen stemmen beschikbaar (tik op pagina en probeer Start)";
    voiceSel.appendChild(opt);
  } else {
    list.forEach((v, i) => {
      const opt = document.createElement('option');
      opt.value = v.name;
      opt.textContent = `${v.name} — ${v.lang}`;
      voiceSel.appendChild(opt);
    });
  }
  updateDebug();
}

function ensureVoicesLoaded(cb) {
  const v = speechSynthesis.getVoices();
  if (v && v.length) { loadVoices(); cb && cb(); return; }
  speechSynthesis.onvoiceschanged = () => { loadVoices(); cb && cb(); };
  setTimeout(() => { loadVoices(); cb && cb(); }, 1200);
}

function updateDebug() {
  const vc = (VOICES||[]).length;
  const nlc = (NL_VOICES||[]).length;
  const sc = (SESSIONS||[]).length;
  debugEl.textContent = `Sessies: ${sc} • Stemmen: ${vc} (NL: ${nlc})`;
}

/* ====== Onthoud laatste sessie + kies default van vandaag ====== */
function pickDefaultSession(){
  try {
    const saved = localStorage.getItem('lastSessIdx');
    if (saved !== null && SESSIONS[+saved]) return +saved;
  } catch(e){}
  const nlDays = ['Zondag','Maandag','Dinsdag','Woensdag','Donderdag','Vrijdag','Zaterdag'];
  const today = nlDays[new Date().getDay()];
  const idx = SESSIONS.findIndex(s => s.title.includes(today));
  return idx >= 0 ? idx : 0;
}

function init() {
  populateSessions();
  const defIdx = pickDefaultSession();
  sessionSel.value = String(defIdx);
  currentSession = SESSIONS[defIdx];
  renderCues(currentSession);
  ensureVoicesLoaded();
  updateDebug();
}

sessionSel.addEventListener('change', () => {
  const idx = parseInt(sessionSel.value, 10);
  currentSession = Number.isInteger(idx) && idx >= 0 ? SESSIONS[idx] : null;
  renderCues(currentSession);
  stopAll();
  try { localStorage.setItem('lastSessIdx', String(idx)); } catch(e){}
});

rateSl.addEventListener('input', () => {
  rateVal.textContent = rateSl.value + '×';
});

function setStatus(txt) {
  statusPill.textContent = txt;
}

let ticker = null;
function startTicker() {
  if (ticker) clearInterval(ticker);
  ticker = setInterval(() => {
    if (!running) return;
    const now = paused ? pausedAt : Date.now();
    elapsedPill.textContent = fmt(now - startEpoch);
  }, 250);
}

function speak(text) {
  const u = new SpeechSynthesisUtterance(text);
  const pick = Array.from(voiceSel.options).find(o => o.selected);
  const v = (NL_VOICES.find(v => v.name === (pick && pick.value)) || VOICES.find(v => v.name === (pick && pick.value)));
  if (v) u.voice = v;
  u.rate = parseFloat(rateSl.value);
  speechSynthesis.speak(u);
}

function schedule(sess, offsetMs=0) {
  clearTimeouts();
  if (!sess || !sess.cues || !sess.cues.length) return;
  const base = Date.now() - offsetMs;
  startEpoch = base;
  sess.cues.forEach((c, idx) => {
    const at = base + c.t*1000;
    const delay = Math.max(0, at - Date.now());

    // pre-beep 1s vóór elke cue
    const pre = Math.max(0, delay - 1000);
    const preId = setTimeout(() => { if (running) beep(); }, pre);
    timeouts.push(preId);

    const id = setTimeout(() => {
      if (!running) return;
      speak(c.text);
      spokenCount = idx + 1;
    }, delay);
    timeouts.push(id);
  });
  startTicker();
}

function clearTimeouts() {
  timeouts.forEach(id => clearTimeout(id));
  timeouts = [];
}

function stopAll() {
  running = false;
  paused = false;
  clearTimeouts();
  speechSynthesis.cancel();
  setStatus('Klaar');
  elapsedPill.textContent = '00:00';
  spokenCount = 0;
}

startBtn.addEventListener('click', () => {
  if (!currentSession) return;
  stopAll();
  running = true;
  paused = false;
  setStatus('Bezig');
  schedule(currentSession, 0);
  try {
    AC = getAC(); // unlock audio
    const o = AC.createOscillator();
    const g = AC.createGain();
    o.connect(g); g.connect(AC.destination);
    g.gain.value = 0.0001;
    o.start(); o.stop(AC.currentTime + 0.05);
  } catch(e){}
});

stopBtn.addEventListener('click', stopAll);

pauseBtn.addEventListener('click', () => {
  if (!running || paused) return;
  paused = true;
  speechSynthesis.pause();
  clearTimeouts();
  pausedAt = Date.now();
  setStatus('Gepauzeerd');
});

resumeBtn.addEventListener('click', () => {
  if (!running || !paused) return;
  paused = false;
  const elapsed = pausedAt - startEpoch;
  const remain = { title: currentSession.title, cues: currentSession.cues.filter(c => c.t*1000 >= elapsed) };
  speechSynthesis.resume();
  setStatus('Bezig');
  schedule(remain, elapsed);
});

document.addEventListener('DOMContentLoaded', init);
document.addEventListener('touchstart', () => ensureVoicesLoaded(), {once:true});
document.addEventListener('click', () => ensureVoicesLoaded(), {once:true});
</script>
</body></html>
