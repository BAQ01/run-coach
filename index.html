<!doctype html>
<html lang="nl"><head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>10K Run Coach</title>
<style>
  :root { --bg:#0b0d10; --fg:#e7f0f7; --muted:#a8b3bd; --accent:#52d1ff; }
  html,body { margin:0; padding:0; background:var(--bg); color: var(--fg);
    font-family: -apple-system, BlinkMacSystemFont, system-ui, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; }
  .wrap { max-width: 820px; margin: 0 auto; padding: 20px 16px 80px; }
  h1 { font-size: 22px; margin: 0 0 12px; }
  p { line-height: 1.5; color: var(--muted); }
  select, button {
    width: 100%; box-sizing: border-box; margin: 8px 0 14px; padding: 12px;
    background: #12161a; color: var(--fg); border: 1px solid #1f2a33; border-radius: 10px;
    -webkit-appearance: none; appearance: none;
  }
  button.primary { background: var(--accent); color: #001018; border: none; font-weight: 700; }
  .row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
  .controls { position: sticky; bottom: 0; left: 0; right: 0;
    background: linear-gradient(180deg, rgba(11,13,16,0.0), rgba(11,13,16,0.85) 18%, rgba(11,13,16,1) 40%);
    padding: 12px 16px 20px; backdrop-filter: blur(6px); }
  .pill { display:inline-block; padding:6px 10px; border:1px solid #23313a; border-radius:999px; color:#bcd; font-size:12px; margin-right:6px; }
  .cue-list { margin-top: 8px; border: 1px solid #1f2a33; border-radius: 10px; overflow: hidden; }
  .cue { padding: 10px 12px; border-top: 1px solid #182028; display:flex; gap:12px; }
  .cue:first-child { border-top: none; }
  .t { color:#9bd; min-width:60px; }
  .txt { flex:1; color:#dbe6ef; word-break: break-word; }
  .warn { color:#ffd699; }
  footer { margin-top: 18px; color: var(--muted); font-size: 13px; }
  .debug { margin-top:8px; font-size:12px; color:#9ab; }
  .ver { margin-top:6px; font-size:12px; color:#788694; }
</style>
</head>
<body>
<div class="wrap">
  <h1>10K Run Coach – iPhone</h1>
  <p>Speelt gesproken aanwijzingen precies op tijd. <span class="warn">Tip:</span> in <b>MP3</b>-modus kan je scherm op slot; in <b>TTS</b>-modus moet het scherm aan blijven.</p>
  <div class="ver">Build: v8 (MP3-first, TTS fallback)</div>

  <label for="session">Kies je sessie</label>
  <select id="session"></select>

  <div class="row">
    <div>
      <label for="voice">Stem (TTS)</label>
      <select id="voice"></select>
    </div>
    <div>
      <div class="pill" id="modePill" style="display:inline-block;margin-top:30px;">—</div>
    </div>
  </div>

  <div class="controls">
    <div class="row">
      <button class="primary" id="startBtn">▶︎ Start</button>
      <button id="stopBtn">■ Stop</button>
    </div>
    <div class="row">
      <button id="pauseBtn">⏸︎ Pauze</button>
      <button id="resumeBtn">⏵︎ Hervat</button>
    </div>
    <div>
      <span class="pill" id="status">Klaar</span>
      <span class="pill" id="elapsed">00:00</span>
    </div>
  </div>

  <div id="cueList" class="cue-list"></div>
  <div class="debug" id="debug">Status…</div>
  <footer>
    <p>Tip: voeg toe aan je beginscherm voor snel starten (Deel ▸ <i>Zet op beginscherm</i>).</p>
  </footer>
</div>

<!-- Onzichtbare speler voor MP3 -->
<audio id="mp3Player" preload="auto" playsinline></audio>

<script>
/* ===== Sessions laden uit tools/sessions.json ===== */
let SESSIONS = [];
async function loadSessions(){
  const res = await fetch('tools/sessions.json', {cache:'no-store'});
  if(!res.ok) throw new Error('Kan tools/sessions.json niet laden');
  SESSIONS = await res.json();
}

/* ---------- UI refs ---------- */
const $ = s => document.querySelector(s);
const sessionSel = $("#session");
const voiceSel   = $("#voice");
const statusPill = $("#status");
const elapsedPill= $("#elapsed");
const cueList    = $("#cueList");
const startBtn   = $("#startBtn");
const stopBtn    = $("#stopBtn");
const pauseBtn   = $("#pauseBtn");
const resumeBtn  = $("#resumeBtn");
const debugEl    = $("#debug");
const modePill   = $("#modePill");
const mp3        = $("#mp3Player");

const MIN_START_DELAY_MS = 220;

let VOICES=[], NL_VOICES=[];
let timeouts=[], ticker=null;
let startEpoch=0, pausedAt=0;
let running=false, paused=false;
let currentSession=null, spokenCount=0;

/* ====== AudioContext voor beep in TTS ====== */
let AC=null;
function getAC(){ try{ if(!AC) AC = new (window.AudioContext||window.webkitAudioContext)(); }catch(e){ AC=null; } return AC; }
function beep(ms=80, freq=880){
  const ac = getAC(); if(!ac) return;
  const o = ac.createOscillator(), g = ac.createGain();
  o.connect(g); g.connect(ac.destination);
  try { g.gain.setValueAtTime(0.0001, ac.currentTime); g.gain.linearRampToValueAtTime(0.08, ac.currentTime+0.01); g.gain.exponentialRampToValueAtTime(0.0001, ac.currentTime+ms/1000); } catch(e){}
  o.frequency.value = freq; o.start(); o.stop(ac.currentTime + ms/1000 + 0.02);
}

/* ---------- helpers ---------- */
function z2(n){return (n<10?'0':'')+n;}
function fmt(ms){ const s = Math.max(0, Math.floor(ms/1000)); return z2(Math.floor(s/60))+':'+z2(s%60); }
function slugify(s){ return s.toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/^-+|-+$/g,'').slice(0,80); }
function mp3UrlFor(sess){ return 'audio/'+slugify(sess.title)+'.mp3'; }

function renderCues(sess){
  cueList.innerHTML = '';
  (sess?.cues||[]).forEach(c=>{
    const row = document.createElement('div');
    row.className='cue';
    const mm=z2(Math.floor(c.t/60)), ss=z2(c.t%60);
    row.innerHTML = `<div class="t">${mm}:${ss}</div><div class="txt">${c.text}</div>`;
    cueList.appendChild(row);
  });
}

function populateSessions(){
  sessionSel.innerHTML='';
  SESSIONS.forEach((s,i)=>{
    const opt=document.createElement('option');
    opt.value=String(i); opt.textContent=s.title;
    sessionSel.appendChild(opt);
  });
}

function updateDebug(){
  debugEl.textContent = `Sessies: ${(SESSIONS||[]).length} • Stemmen: ${(VOICES||[]).length} (NL: ${(NL_VOICES||[]).length})`;
}

function loadVoices(){
  VOICES = speechSynthesis.getVoices()||[];
  NL_VOICES = VOICES.filter(v => (v.lang||'').toLowerCase().startsWith('nl'));
  voiceSel.innerHTML='';
  const list = NL_VOICES.length ? NL_VOICES : VOICES;
  if(!list.length){
    const opt=document.createElement('option'); opt.value=''; opt.textContent='⚠︎ Geen stemmen beschikbaar (tik en probeer Start)';
    voiceSel.appendChild(opt);
  }else{
    list.forEach(v=>{
      const opt=document.createElement('option');
      opt.value=v.name; opt.textContent=`${v.name} — ${v.lang}`;
      voiceSel.appendChild(opt);
    });
  }
  updateDebug();
}

function ensureVoicesLoaded(cb){
  const v=speechSynthesis.getVoices();
  if(v && v.length){ loadVoices(); cb&&cb(); return; }
  speechSynthesis.onvoiceschanged=()=>{ loadVoices(); cb&&cb(); };
  setTimeout(()=>{ loadVoices(); cb&&cb(); }, 1200);
}

/* ===== Mode: MP3 of TTS ===== */
let useMP3=false;
async function pickAudioModeFor(sess){
  useMP3=false; modePill.textContent='TTS';
  mp3.removeAttribute('src');
  if(!sess) return;
  const url=mp3UrlFor(sess);
  try{
    const res=await fetch(url,{method:'HEAD',cache:'no-store'});
    if(res.ok){
      useMP3=true; modePill.textContent='MP3';
      mp3.src=url; mp3.load();
      mp3.defaultPlaybackRate=1.0; mp3.playbackRate=1.0;
    }
  }catch(e){}
}

/* ===== Ticker ===== */
function startTicker(){
  if(ticker) clearInterval(ticker);
  ticker = setInterval(()=>{
    if(!running) return;
    if(useMP3){
      elapsedPill.textContent = fmt(Math.floor((mp3.currentTime||0)*1000));
    }else{
      const now = paused? pausedAt : Date.now();
      elapsedPill.textContent = fmt(now - startEpoch);
    }
  }, 250);
}

/* ===== TTS speak (met iOS workarounds) ===== */
function speak(text){
  // iOS-werkvorm: elke keer vers de stemmen pakken
  const voices = speechSynthesis.getVoices()||[];
  const selName = voiceSel?.value;
  const pick = voices.find(v=>v.name===selName)
        || voices.find(v=>(v.lang||'').toLowerCase().startsWith('nl'))
        || voices[0];

  const u = new SpeechSynthesisUtterance(text);
  if(pick){ u.voice=pick; u.lang=pick.lang||'nl-NL'; }
  u.rate=1.0; u.pitch=1.0; u.volume=1.0;
  speechSynthesis.speak(u);
}

/* ===== Planner (alleen voor TTS) ===== */
function clearTimeouts(){ timeouts.forEach(id=>clearTimeout(id)); timeouts=[]; }

function schedule(sess, offsetMs=0){
  clearTimeouts();
  if(!sess || !sess.cues || !sess.cues.length) return;
  const base = Date.now() + MIN_START_DELAY_MS - offsetMs; // kleine startvertraging
  startEpoch = base;
  sess.cues.forEach((c, idx)=>{
    const at = base + c.t*1000;
    const delay = Math.max(0, at - Date.now());

    const pre = Math.max(0, delay - 1000);
    timeouts.push(setTimeout(()=>{ if(running && !useMP3) beep(); }, pre));

    timeouts.push(setTimeout(()=>{
      if(!running || useMP3) return;
      speak(c.text);
      spokenCount = idx+1;
    }, delay));
  });
  startTicker();
}

/* ===== Controls ===== */
function setStatus(t){ statusPill.textContent=t; }

function stopAll(){
  running=false; paused=false;
  clearTimeouts();
  if(useMP3){ try{ mp3.pause(); mp3.currentTime=0; }catch(e){} }
  else { speechSynthesis.cancel(); }
  setStatus('Klaar');
  elapsedPill.textContent='00:00';
  spokenCount=0;
}

startBtn.addEventListener('click', ()=>{
  if(!currentSession) return;
  stopAll(); running=true; paused=false; setStatus('Bezig');

  // “Unlock” audio voor iOS (beep)
  try{
    const ac=getAC(); const o=ac.createOscillator(), g=ac.createGain();
    o.connect(g); g.connect(ac.destination); g.gain.value=0.0001; o.start(); o.stop(ac.currentTime+0.05);
  }catch(e){}

  if(useMP3){
    mp3.currentTime=0; mp3.defaultPlaybackRate=1.0; mp3.playbackRate=1.0;
    mp3.play().catch(()=>{ /* user gesture nodig */ });
    startTicker();
  }else{
    // volledig cancel + mini-delay voorkomt “trage stem” in iOS
    speechSynthesis.cancel();
    setTimeout(()=>{ ensureVoicesLoaded(()=>schedule(currentSession,0)); }, MIN_START_DELAY_MS);
  }
});

stopBtn.addEventListener('click', stopAll);

pauseBtn.addEventListener('click', ()=>{
  if(!running || paused) return;
  paused=true; setStatus('Gepauzeerd');
  if(useMP3){
    mp3.pause();
  }else{
    // iOS-bug: liever cancel + later herplannen dan pause()
    speechSynthesis.cancel();
    clearTimeouts();
    pausedAt = Date.now();
  }
});

resumeBtn.addEventListener('click', ()=>{
  if(!running || !paused) return;
  paused=false; setStatus('Bezig');
  if(useMP3){
    mp3.play().catch(()=>{});
  }else{
    const elapsed = pausedAt - startEpoch;
    const remain = { title: currentSession.title, cues: currentSession.cues.filter(c => c.t*1000 >= elapsed) };
    setTimeout(()=>schedule(remain, elapsed), MIN_START_DELAY_MS);
  }
});

/* MP3 status */
mp3.addEventListener('ended', ()=>{ running=false; paused=false; setStatus('Klaar'); });

/* ===== Init ===== */
async function init(){
  await loadSessions();
  populateSessions();
  currentSession = SESSIONS[0]; // default eerste
  sessionSel.value = '0';
  renderCues(currentSession);
  await pickAudioModeFor(currentSession);
  ensureVoicesLoaded();
  updateDebug();
}
sessionSel.addEventListener('change', async ()=>{
  const idx = +sessionSel.value;
  currentSession = SESSIONS[idx] || null;
  renderCues(currentSession);
  stopAll();
  await pickAudioModeFor(currentSession);
});

document.addEventListener('DOMContentLoaded', init);
document.addEventListener('touchstart', ()=>ensureVoicesLoaded(), {once:true});
document.addEventListener('click', ()=>ensureVoicesLoaded(), {once:true});
</script>
</body></html>
